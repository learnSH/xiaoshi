---
title: 监控文件夹下新文件生成
date: 2020-02-04 13:20:20
permalink: /pages/33ec2c9a9b92f
categories:
  - 《Python》开发笔记
tags:
  - Python
author:
  name: xiaoshi
  link: https://github.com/learnSH
---
# 监控文件夹下新文件生成

```python
# 监控文件夹下新文件生成
import os
import time
from subprocess import check_output,Popen, PIPE
import re

file_set = set()

def is_file_in_use(filepath):
    try:
        lsout = Popen(['lsof', filepath], stdout=PIPE, shell=False)
        check_output(["grep", filepath], stdin=lsout.stdout, shell=False)
        return True;
    except:
        print("完成"+filepath)
        return False;


def get_file_size(file_path):
    """
    获取文件大小
    :param file_path: 文件路径
    :return: 文件大小，单位为字节
    """
    return os.stat(file_path).st_size


def monitor_folder(path):
    """监听文件生成, 递归查询该文件夹下所有的子文件"""
    for foldername, _, filenames in os.walk(path):
        for filename in filenames:
            filepath = os.path.join(foldername, filename)
            if filename.startswith('.') or not os.path.isfile(filepath):
                break
            # 添加一个if判断，直接跳过已在file_set中的文件
            if filepath in file_set:
                break
            if not is_file_in_use(filepath):
                file_set.add(filepath)
                print(f"新文件来啦: {filepath}, 大小：" + str(get_file_size(filepath)) + "字节")
    time.sleep(1)
    monitor_folder(path)


# 获取文件名称
def get_file_name(file_url):
    # 使用正则表达式匹配最后一个斜杠后面的内容
    result = re.search(r"/([^/]+)$", file_url)
    return str(result.group(1))
 


# 因为我是部署在linux下的，如果你用的是win的，那获取文件名称的正则就需要换的
if __name__ == "__main__":
    monitor_folder("/home/test/1/")


```

