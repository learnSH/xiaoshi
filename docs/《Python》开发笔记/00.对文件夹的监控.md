---
title: 监控文件夹下新文件生成
date: 2020-02-04 13:20:20
permalink: /pages/33ec2c9a9b92f
categories:
  - 《Python》开发笔记
tags:
  - Python
author:
  name: xiaoshi
  link: https://github.com/learnSH
---
# 监控文件夹下新文件生成

```python
# 监控文件夹下新文件生成
import os
import time
from subprocess import check_output,Popen, PIPE
import re


def is_file_in_use(filepath):
    try:
        lsout = Popen(['lsof', filepath], stdout=PIPE, shell=False)
        check_output(["grep", filepath], stdin=lsout.stdout, shell=False)
        return True;
    except:
        print("完成"+filepath)
        return False;


def get_file_size(file_path):
    """
    获取文件大小
    :param file_path: 文件路径
    :return: 文件大小，单位为字节
    """
    return os.stat(file_path).st_size


def monitor_folder(path):
    """
    监听文件生成
    """
    file_set = set()
    while True:
        for filename in os.listdir(path):
            filepath = os.path.join(path, filename)
            if filename.startswith('.') or not os.path.isfile(filepath):
                continue
            if filepath not in file_set and not is_file_in_use(filepath):
                file_set.add(filepath)
                print(f"新文件来啦: {filepath}" + str(get_file_size(filepath)) +"字节")
                
        time.sleep(1)


# 获取文件名称
def get_file_name(file_url):
    # 使用正则表达式匹配最后一个斜杠后面的内容
    pattern = re.compile('.*/([^/]+)$')
    matcher = pattern.match(file_url)
    if matcher:
        result = matcher.group(1)
        return result
    return None

# 获取文件地址
def get_file_url(FileUrl):
    # 正则表达式：匹配最后一个 / 之前的所有字符
    pattern = re.compile(".*/")
    matcher = pattern.search(FileUrl)
    if matcher:
        result = matcher.group(0)
        return result
    return None


if __name__ == "__main__":
    monitor_folder("/home/test/1/")


```

