---
title: 监控文件夹下新文件生成
date: 2020-02-04 13:20:20
permalink: /pages/33ec2c9a9b92f
categories:
  - 《Python》开发笔记
tags:
  - Python
author:
  name: xiaoshi
  link: https://github.com/learnSH
---
# 监控文件夹下新文件生成

#### 部分代码是因为需要上传华为对象存储，如果不需要删掉即可
#### 使用了watchdog进行监视，避免一直对文件夹循环查询。
```python
import time
import os
import re
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
from subprocess import check_output, Popen, PIPE
from obs import ObsClient


class MyHandler(FileSystemEventHandler):
    file_set = set()

    def __init__(self, obs_client):
        self.obs_client = obs_client

    def is_file_in_use(self, filepath):
        try:
            lsout = Popen(['lsof', filepath], stdout=PIPE, shell=False)
            check_output(["grep", filepath], stdin=lsout.stdout, shell=False)
            return True;
        except:
            return False;

    def get_file_size(self, file_path):
        """获取文件大小"""
        return os.stat(file_path).st_size

    def on_created(self, event):
        if not event.is_directory:
            filepath = event.src_path
            filename = os.path.basename(filepath)

            if filename.startswith('.') or not os.path.isfile(filepath):
                print("文件不对")
                return

            if filepath in self.file_set:
                print("已存在")
                return

            while True:
                if not self.is_file_in_use(filepath):
                    self.file_set.add(filepath)
                    print(f"新文件来啦: {filepath}, 大小：" + str(self.get_file_size(filepath)) + "字节")
                    self.obs_client.putFile(bucketName=str(ObsClientSingleton.BUCKET_NAME), objectKey=str(self.get_file_name(filepath)), file_path=str(filepath))
                    break

    def get_file_name(self, file_url):
        # 使用正则表达式匹配最后一个斜杠后面的内容
        result = re.search(r"/([^/]+)$", file_url)
        return str(result.group(1))


class ObsClientSingleton(object):
    BUCKET_NAME = "sd-qypt"
    ak = "xxx"
    sk = "xxx"
    endPoint = "https://obs.xxx"
    obsClient = None

    if (obsClient == None):
        # 创建ObsClient实例
        obsClient = ObsClient(
            access_key_id=ak,
            secret_access_key=sk,
            server=endPoint
        )


if __name__ == "__main__":
    path = "/home/test/1/"
    event_handler = MyHandler(ObsClientSingleton.obsClient)
    observer = Observer()
    observer.schedule(event_handler, path, recursive=True)
    observer.start()

    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        observer.stop()

    observer.join()


```

